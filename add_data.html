<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>إدارة بيانات Aden_plaste</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body { font-family: Arial; background: #f5f5f5; padding: 20px; direction: rtl; }
  table { width:100%;border-collapse:collapse;margin-top:20px; }
  th,td { border:1px solid #ccc;padding:8px;text-align:center; background:#fff; }
  button { padding:5px 10px; margin:2px; }
</style>
</head>
<body>

<h2 style="text-align:center;">إدارة الأصناف - Aden Plastic</h2>
<div id="tools" style="text-align:center;">
  <button onclick="addRow()">➕ إضافة</button>
  <button onclick="saveData()">💾 حفظ التعديلات</button>
</div>
<table id="tbl">
  <thead>
    <tr><th>الاسم</th><th>الصورة</th><th>حذف</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
const repo = 'T772299420/Aden_plaste';
const path = 'Data.csv';
const branch = 'main';
const token = 'ghp_YOUR_TOKEN_HERE'; // ✳️ استبدل هذا بالتوكن الخاص بك
let currentSHA = '';
let data = [];

window.onload = () => {
  loadData();
};

async function loadData(){
  const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`);
  const js = await res.json();
  currentSHA = js.sha;
  const txt = atob(js.content.trim());
  const wb = XLSX.read(txt, { type: 'string' });
  data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
  showTable();
}

function showTable(){
  const tbl = document.getElementById('tbl');
  const bb = tbl.querySelector('tbody');
  bb.innerHTML = '';
  data.forEach((row, i) => {
    const tr = bb.insertRow();
    const tdName = tr.insertCell();
    tdName.contentEditable = true;
    tdName.innerText = row.name || '';

    const tdImg = tr.insertCell();
    tdImg.contentEditable = true;
    tdImg.innerText = row.image || '';

    const tdDel = tr.insertCell();
    const btn = document.createElement('button');
    btn.innerText = '🗑️';
    btn.onclick = () => { data.splice(i, 1); showTable(); };
    tdDel.appendChild(btn);
  });
}

function addRow(){
  data.push({name:'', image:''});
  showTable();
}

async function saveData(){
  const rows = [];
  document.querySelectorAll('#tbl tbody tr').forEach(tr => {
    const name = tr.cells[0].innerText.trim();
    const image = tr.cells[1].innerText.trim();
    if (name) rows.push({name, image});
  });

  const ws = XLSX.utils.json_to_sheet(rows);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
  const out = XLSX.write(wb, { bookType: 'csv', type: 'array' });
  const b64 = btoa(new Uint8Array(out).reduce((s, c) => s + String.fromCharCode(c), ''));

  const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
    method: 'PUT',
    headers: {
      Authorization: `token ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      message: 'تحديث الملف من واجهة HTML',
      content: b64,
      sha: currentSHA,
      branch
    })
  });

  const js = await res.json();
  if (res.ok) {
    alert('✅ تم الحفظ بنجاح');
    currentSHA = js.content.sha;
  } else {
    alert('❌ فشل الحفظ: ' + js.message);
  }
}
</script>
</body>
</html>
