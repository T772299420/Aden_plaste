<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>إدارة الأصناف - عدن بلاستيك</title>

  <style>
    body {
      font-family: 'Times New Roman', serif;
      background: #f9f9f9;
      margin: 0; padding: 20px;
      color: #222;
    }
    h1 {
      text-align: center;
      color: #8B0000;
    }
    input[type="text"], input[type="url"] {
      width: 90%;
      padding: 6px;
      margin: 4px 0 12px 0;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      box-shadow: 0 0 10px #ddd;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background: #8B0000;
      color: white;
    }
    img {
      max-width: 100px;
      max-height: 80px;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: border-color 0.3s ease;
    }
    img:hover {
      border-color: #8B0000;
    }
    button {
      background: #8B0000;
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin: 2px;
    }
    button:hover {
      background: #a03030;
    }
    #searchInput {
      width: 50%;
      padding: 8px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    #addRowBtn {
      margin: 15px auto;
      display: block;
      font-weight: bold;
    }
    #statusMsg {
      text-align: center;
      margin-top: 15px;
      font-weight: bold;
      color: green;
    }
    #errorMsg {
      color: red;
    }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

</head>
<body>

  <h1>إدارة الأصناف - عدن بلاستيك</h1>

  <input type="text" id="searchInput" placeholder="ابحث باسم الصنف..." />

  <button id="addRowBtn">+ إضافة صنف جديد</button>

  <table id="itemsTable">
    <thead>
      <tr>
        <th>اسم الصنف</th>
        <th>صورة الصنف (رابط)</th>
        <th>عرض الصورة</th>
        <th>تعديل</th>
        <th>حذف</th>
      </tr>
    </thead>
    <tbody>
      <!-- البيانات ستدخل هنا -->
    </tbody>
  </table>

  <div id="statusMsg"></div>
  <div id="errorMsg"></div>

<script>
  // --- بيانات خاصة بمستودع GitHub ---
  const OWNER = 'T772299420';
  const REPO = 'Aden_plaste';
  const FILE_PATH = 'Data.csv';
  const BRANCH = 'main';

  // ضع توكن GitHub هنا بحذر (ليس في تطبيق إنتاجي مباشر)
  const GITHUB_TOKEN = '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';

  let currentSha = null;  // تخزن sha الخاص بالملف للتحديث لاحقاً
  let itemsData = [];     // مصفوفة الكائنات للصنف

  const tableBody = document.querySelector('#itemsTable tbody');
  const searchInput = document.getElementById('searchInput');
  const statusMsg = document.getElementById('statusMsg');
  const errorMsg = document.getElementById('errorMsg');
  const addRowBtn = document.getElementById('addRowBtn');

  // تحميل الملف من GitHub
  async function fetchFile() {
    statusMsg.textContent = 'جارٍ تحميل البيانات من GitHub...';
    errorMsg.textContent = '';

    const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}?ref=${BRANCH}`;

    try {
      const res = await fetch(url, {
        headers: {
          Authorization: `token ${GITHUB_TOKEN}`,
          Accept: 'application/vnd.github.v3.raw'
        }
      });

      if (!res.ok) {
        throw new Error(`خطأ في جلب الملف: ${res.status} ${res.statusText}`);
      }

      // نحتاج هنا الحصول على البيانات كـ json لقراءة sha ثم قراءة المحتوى base64
      const json = await res.json();
      currentSha = json.sha;

      // محتوى الملف مشفر base64
      const contentBase64 = json.content.replace(/\n/g, '');
      const contentStr = atob(contentBase64);

      // تحويل CSV إلى JSON
      const wb = XLSX.read(contentStr, { type: 'string' });
      const sheet = wb.Sheets[wb.SheetNames[0]];
      itemsData = XLSX.utils.sheet_to_json(sheet, { defval: '' });

      renderTable(itemsData);
      statusMsg.textContent = 'تم تحميل البيانات بنجاح.';
    } catch (err) {
      errorMsg.textContent = 'حدث خطأ أثناء تحميل البيانات: ' + err.message;
      statusMsg.textContent = '';
      console.error(err);
    }
  }

  // رسم الجدول حسب البيانات
  function renderTable(data) {
    tableBody.innerHTML = '';

    data.forEach((item, idx) => {
      const tr = document.createElement('tr');

      tr.innerHTML = `
        <td><input type="text" value="${item.name}" data-index="${idx}" data-field="name" /></td>
        <td><input type="url" value="${item.image}" data-index="${idx}" data-field="image" /></td>
        <td>${item.image ? `<img src="${item.image}" alt="${item.name}" title="${item.name}" />` : ''}</td>
        <td><button class="saveBtn" data-index="${idx}">حفظ</button></td>
        <td><button class="deleteBtn" data-index="${idx}">حذف</button></td>
      `;

      tableBody.appendChild(tr);
    });
  }

  // حفظ التغييرات إلى GitHub
  async function saveData() {
    statusMsg.textContent = 'جارٍ حفظ البيانات على GitHub...';
    errorMsg.textContent = '';

    try {
      // إنشاء CSV من itemsData
      const ws = XLSX.utils.json_to_sheet(itemsData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Sheet1');
      const csvData = XLSX.utils.sheet_to_csv(ws);

      // تحويل CSV إلى Base64
      const base64Content = btoa(unescape(encodeURIComponent(csvData)));

      // طلب PUT إلى GitHub API
      const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${FILE_PATH}`;

      const body = {
        message: 'تحديث بيانات الأصناف',
        content: base64Content,
        sha: currentSha,
        branch: BRANCH
      };

      const res = await fetch(url, {
        method: 'PUT',
        headers: {
          Authorization: `token ${GITHUB_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) {
        const err = await res.json();
        throw new Error(err.message || 'فشل تحديث الملف');
      }

      const data = await res.json();
      currentSha = data.content.sha; // تحديث SHA للملف الجديد

      statusMsg.textContent = 'تم حفظ البيانات بنجاح.';
    } catch (err) {
      errorMsg.textContent = 'حدث خطأ أثناء الحفظ: ' + err.message;
      statusMsg.textContent = '';
      console.error(err);
    }
  }

  // حدث البحث والفلترة
  searchInput.addEventListener('input', () => {
    const term = searchInput.value.trim().toLowerCase();
    const filtered = itemsData.filter(item => item.name.toLowerCase().includes(term));
    renderTable(filtered);
  });

  // إضافة صف جديد فارغ
  addRowBtn.addEventListener('click', () => {
    itemsData.push({ name: '', image: '' });
    renderTable(itemsData);
  });

  // التعامل مع أزرار الحفظ والحذف في الجدول
  tableBody.addEventListener('click', e => {
    if (e.target.classList.contains('saveBtn')) {
      const idx = e.target.getAttribute('data-index');
      // تحديث القيم من inputs
      const row = tableBody.children[idx];
      const inputs = row.querySelectorAll('input');
      itemsData[idx].name = inputs[0].value.trim();
      itemsData[idx].image = inputs[1].value.trim();

      saveData();
    }
    if (e.target.classList.contains('deleteBtn')) {
      const idx = e.target.getAttribute('data-index');
      if (confirm('هل أنت متأكد من حذف هذا الصنف؟')) {
        itemsData.splice(idx, 1);
        renderTable(itemsData);
        saveData();
      }
    }
  });

  // تحديث البيانات عند التعديل مباشرة في الحقول (حفظ تلقائي)
  tableBody.addEventListener('input', e => {
    if (e.target.tagName.toLowerCase() === 'input') {
      const idx = e.target.getAttribute('data-index');
      const field = e.target.getAttribute('data-field');
      itemsData[idx][field] = e.target.value;
    }
  });

  // تحميل البيانات عند بداية تشغيل الصفحة
  fetchFile();

</script>
</body>
  </html>
