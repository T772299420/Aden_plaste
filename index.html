<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>شركة عدن الوطنية للصناعات المنزلية</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <style>
    body {
      font-family: Arial;
      padding: 10px;
      background: #f5f5f5;
      text-align: center;
    }
    img.logo {
      width: 200px;
      margin-bottom: 20px;
      position: relative;
      animation: move-logo 5s alternate infinite;
    }
    @keyframes move-logo {
      0% { transform: translateX(100px); }
      100% { transform: translateX(-100px); }
    }
    .item {
      background: #fff;
      margin: 10px auto;
      padding: 10px;
      border-radius: 10px;
      width: 90%;
      box-shadow: 0 0 5px #ccc;
      text-align: right;
    }
    .item img {
      width: 100px;
      height: auto;
    }
    input[type=number] {
      width: 60px;
      margin-right: 5px;
    }
    button {
      padding: 10px 20px;
      margin-top: 20px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      background: #25D366;
      color: white;
    }
    #reset {
      background: #f44336;
      margin-right: 10px;
    }
    #filePathDisplay {
      margin-top: 10px;
      padding: 8px;
      width: 90%;
      border: 1px solid #ccc;
      border-radius: 6px;
      background-color: #fff;
    }
  </style>
</head>
<body>
  <img src="logo.png" class="logo" alt="Aden Plastic Logo" />
  <h2>شركة عدن الوطنية للصناعات المنزلية</h2>

  <div id="items"></div>

  <button onclick="sendToWhatsApp()">إرسال الطلب عبر واتساب</button>
  <button id="reset" onclick="resetFilePath()">إعادة اختيار الملف</button>

  <input type="file" id="fileInput" accept=".xlsx" style="display:none" />
  <input type="text" id="filePathDisplay" placeholder="اسم الملف المختار" readonly />

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const savedExcel = localStorage.getItem('excelFileBase64');
      if (savedExcel) {
        document.getElementById('filePathDisplay').value = "تم تحميل الملف من التخزين المحلي";
        loadExcelData(savedExcel);
      } else {
        chooseFile();
      }
    });

    function chooseFile() {
      document.getElementById('fileInput').click();
    }

    document.getElementById('fileInput').addEventListener('change', async (event) => {
      const file = event.target.files[0];
      if (file) {
        document.getElementById('filePathDisplay').value = file.name;
        const reader = new FileReader();
        reader.onload = (e) => {
          const data = e.target.result;
          const base64 = btoa(String.fromCharCode(...new Uint8Array(data)));
          localStorage.setItem('excelFileBase64', base64);
          loadExcelData(base64);
        };
        reader.readAsArrayBuffer(file);
      }
    });

    function resetFilePath() {
      localStorage.removeItem('excelFileBase64');
      document.getElementById('filePathDisplay').value = "";
      chooseFile();
    }

    function loadExcelData(base64String) {
      const binary = atob(base64String);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      const workbook = XLSX.read(bytes, { type: 'array' });
      const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
      const jsonData = XLSX.utils.sheet_to_json(firstSheet);
      displayItems(jsonData);
    }

    function displayItems(itemsData) {
      const itemsDiv = document.getElementById('items');
      itemsDiv.innerHTML = '';
      const imgbbBaseUrl = 'https://i.ibb.co/';

      itemsData.forEach(item => {
        const imagePath = item.image?.trim() || ''; // يجب أن يكون مثل: qfLMyz3/image.jpg
        const imageUrl = imgbbBaseUrl + imagePath;

        const itemDiv = document.createElement('div');
        itemDiv.className = 'item';
        itemDiv.innerHTML = `
          <img src="${imageUrl}" alt="${item.name}" onerror="this.src='notfound.jpg';">
          <p>${item.name}</p>
          <label>الكمية: <input type="number" min="0" value="" data-name="${item.name}"> </label>
        `;
        itemsDiv.appendChild(itemDiv);
      });
    }

    function sendToWhatsApp() {
      const inputs = document.querySelectorAll('input[type="number"]');
      let message = 'طلبية من شركة عدن:\n';
      inputs.forEach(input => {
        const qty = input.value;
        const name = input.getAttribute('data-name');
        if (qty && parseInt(qty) > 0) {
          message += `- ${name}: ${qty}\n`;
        }
      });
      const encodedMsg = encodeURIComponent(message);
      const whatsappURL = `https://wa.me/?text=${encodedMsg}`;
      window.open(whatsappURL, '_blank');
    }
  </script>
</body>
</html>
