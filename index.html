<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø´Ø±ÙƒØ© Ø¹Ø¯Ù† Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ù„Ù„ØµÙ†Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f9f9f9; margin: 0; padding: 0; color: #333; }
    h2 { color: #8B0000; margin-bottom: 20px; font-weight: 700; text-align: center; }
    #tabBar {
      background: #8B0000; display: flex; align-items: center;
      padding: 10px 15px; gap: 15px; flex-wrap: wrap; position: sticky; top: 0; z-index: 1000;
    }
    #tabBar button.tabBtn {
      background: transparent; border: none; color: #fff;
      font-size: 18px; cursor: pointer; padding: 10px 18px; border-radius: 8px;
    }
    #tabBar button.tabBtn.active, #tabBar button.tabBtn:hover {
      background: #f44336;
    }
    .search-container {
      margin-left: auto; display: flex; align-items: center; gap: 10px;
    }
    #searchInput {
      padding: 7px 12px; font-size: 16px; border-radius: 8px; border: none; width: 200px;
    }
    #searchBtn, #whatsappBtn, #showOrderBtn, #btnClientInfo, #btnNewOrder {
      padding: 9px 14px; border-radius: 8px; cursor: pointer;
      font-size: 16px; border: none; color: #fff;
    }
    #searchBtn { background: #f44336; }
    #whatsappBtn, #showOrderBtn { background: #25d366; margin-left: 10px; }
    #btnClientInfo { background: #004d40; margin-left: 10px; }
    #btnNewOrder { background: #FF9800; margin-left: 10px; }
    .tabContent {
      display: none; padding: 20px; max-width: 1100px; margin: auto; background: white;
    }
    .tabContent.active { display: block; }
    .group-section { margin-bottom: 20px; }
    .group-header {
      background: #8B0000; color: #fff; padding: 12px 18px; font-size: 1.2rem; font-weight: bold;
      cursor: pointer; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
    }
    .group-items {
      display: grid; grid-template-columns: repeat(auto-fill,minmax(230px,1fr));
      gap: 20px; padding: 15px 10px;
    }
    .group-collapsed .group-items { display: none; }
    .group-arrow { font-size: 1.4rem; transition: transform 0.3s ease; }
    .group-collapsed .group-arrow { transform: rotate(90deg); }
    .item {
      border: 1px solid #ccc; padding: 10px; border-radius: 8px; background: #fefefe;
    }
    .item.highlighted { border-color: #f44336; background: #fff0f0; }
    .image-box img {
      width: 100%; height: 200px; object-fit: contain;
    }
    .item-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .item-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .notes-btn {
      background-color: #2196f3;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    .modal {
      display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;
    }
    .modal-content {
      background: #fff; border-radius: 8px; padding: 20px; max-width: 400px; width: 90%;
      box-shadow: 0 0 10px rgba(0,0,0,0.3); text-align: center;
    }
    .modal textarea, .modal input {
      width: 100%; margin-top: 10px; font-size: 16px; padding: 8px;
      border-radius: 6px; border: 1px solid #ccc; resize: vertical; box-sizing: border-box;
    }
    .modal input { height: 36px; }
    .modal-buttons {
      margin-top: 15px; display: flex; justify-content: space-around;
    }
    .modal-buttons button {
      padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;
    }
    .btn-yes { background-color: #28a745; color: white; }
    .btn-no { background-color: #dc3545; color: white; }
    mark {
      background: yellow; color: black; padding: 0 4px;
    }
  </style>
</head>
<body>
  <div id="tabBar">
    <button class="tabBtn active" data-tab="sales">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
    <button class="tabBtn" data-tab="client">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù..." />
      <button id="searchBtn">ğŸ”</button>
      <button id="showOrderBtn" style="display:none;">Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨</button>
      <button id="whatsappBtn" style="display:none;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      <button id="btnNewOrder">ğŸ—‘ï¸ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    </div>
  </div>

  <div id="sales" class="tabContent active">
    <h2>Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
    <div id="salesItems"></div>
  </div>

  <div id="client" class="tabContent">
    <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
    <div>
      <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ:</label><input type="text" id="clientFullName" /><br><br>
      <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ:</label><input type="text" id="clientTradeName" /><br><br>
      <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ù„:</label><input type="text" id="clientAddress" /><br><br>
      <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label><input type="text" id="clientPhone" dir="ltr" /><br><br>
      <button id="saveClientInfoBtn" class="btn-yes">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>
  </div>
  <!-- Ø§Ù„Ù†ÙˆØ§ÙØ° -->
<div id="itemNoteModal" class="modal">
  <div class="modal-content">
    <h3>Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù</h3>
    <textarea id="itemNoteTextarea" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ù‡Ù†Ø§..."></textarea>
    <div class="modal-buttons">
      <button class="btn-yes" id="saveItemNoteBtn">Ø­ÙØ¸</button>
      <button class="btn-no" id="cancelItemNoteBtn">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<div id="noteModal" class="modal">
  <div class="modal-content">
    <p>Ù‡Ù„ ØªØ±ØºØ¨ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨ØŸ</p>
    <div class="modal-buttons">
      <button class="btn-yes" id="btnAddNote">Ù†Ø¹Ù…</button>
      <button class="btn-no" id="btnSendWithoutNote">Ù„Ø§</button>
    </div>
  </div>
</div>

<div id="inputNoteModal" class="modal">
  <div class="modal-content">
    <p>Ø£Ø¯Ø®Ù„ Ù…Ù„Ø§Ø­Ø¸ØªÙƒ Ø¹Ù„Ù‰ Ø§Ù„Ø·Ù„Ø¨:</p>
    <textarea id="orderNote" placeholder="Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§ØªÙƒ Ù‡Ù†Ø§..."></textarea>
    <div class="modal-buttons">
      <button class="btn-yes" id="btnSendWithNote">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
      <button class="btn-no" id="btnCancelNote">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<script>
let itemsData = [];
let savedQuantities = JSON.parse(localStorage.getItem('selectedQuantities') || '{}');
let savedItemNotes = JSON.parse(localStorage.getItem('itemNotes') || '{}');
let clientInfo = JSON.parse(localStorage.getItem('clientInfo') || '{}');
let currentNoteItem = null;
let currentKeyword = '';

document.addEventListener('DOMContentLoaded', () => {
  fetch('https://raw.githubusercontent.com/T772299420/Aden_plaste/main/data%20(7).csv')
    .then(res => res.text())
    .then(text => {
      const rows = text.trim().split('\n').map(row => row.split(','));
      const headers = rows.shift();
      itemsData = rows.map(row => {
        const obj = {};
        headers.forEach((h, i) => obj[h.trim().toLowerCase()] = row[i]?.trim() || '');
        return obj;
      });

      const clientName = clientInfo.fullName || 'Ø§Ù„Ø¹Ù…ÙŠÙ„';
      const tradeName = clientInfo.tradeName || '';
      if (Object.keys(savedQuantities).length > 0) {
        if (confirm(`Ø§Ù„Ø¹Ù…ÙŠÙ„ / ${clientName} - ${tradeName}\nÙŠÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨ Ù…Ø­ÙÙˆØ¸ Ù…Ù† Ù‚Ø¨Ù„. Ù‡Ù„ ØªØ±ØºØ¨ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ØŸ`)) {
          clearOrder();
        }
      }

      renderSalesItems();
      fillClientInputs();
      updateButtonsVisibility();
    });

  document.getElementById('searchInput').addEventListener('input', (e) => {
    currentKeyword = e.target.value.trim().toLowerCase();
    if (!currentKeyword) renderSalesItems();
    else filterItems(currentKeyword);
  });

  document.getElementById('saveClientInfoBtn').onclick = () => {
    clientInfo = {
      fullName: document.getElementById('clientFullName').value.trim(),
      tradeName: document.getElementById('clientTradeName').value.trim(),
      address: document.getElementById('clientAddress').value.trim(),
      phone: document.getElementById('clientPhone').value.trim(),
    };
    localStorage.setItem('clientInfo', JSON.stringify(clientInfo));
    alert("ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„");
  };

  document.querySelectorAll('.tabBtn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tabBtn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tabContent').forEach(tab => tab.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');
    });
  });

  document.getElementById('btnNewOrder').onclick = () => {
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ØŸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙƒÙ…ÙŠØ§Øª ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª.")) {
      clearOrder();
      renderSalesItems();
      updateButtonsVisibility();
    }
  };

  document.getElementById('showOrderBtn').onclick = () => {
    const items = Object.keys(savedQuantities);
    if (!items.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù.");
    let msg = "Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ:\n\n";
    items.forEach(name => {
      msg += `- ${name}: ${savedQuantities[name]}`;
      if (savedItemNotes[name]) msg += ` (Ù…Ù„Ø§Ø­Ø¸Ø©: ${savedItemNotes[name]})`;
      msg += '\n';
    });
    alert(msg);
  };

  document.getElementById('whatsappBtn').onclick = () => {
    if (!Object.keys(savedQuantities).length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù.");
    document.getElementById('noteModal').style.display = 'flex';
  };

  document.getElementById('btnAddNote').onclick = () => {
    document.getElementById('noteModal').style.display = 'none';
    document.getElementById('inputNoteModal').style.display = 'flex';
  };
  document.getElementById('btnSendWithoutNote').onclick = () => {
    document.getElementById('noteModal').style.display = 'none';
    sendOrderWhatsApp('');
  };
  document.getElementById('btnSendWithNote').onclick = () => {
    const note = document.getElementById('orderNote').value.trim();
    sendOrderWhatsApp(note);
    document.getElementById('inputNoteModal').style.display = 'none';
    document.getElementById('orderNote').value = '';
  };
  document.getElementById('btnCancelNote').onclick = () => {
    document.getElementById('inputNoteModal').style.display = 'none';
  };

  document.getElementById('saveItemNoteBtn').onclick = () => {
    const note = document.getElementById('itemNoteTextarea').value.trim();
    if (note) savedItemNotes[currentNoteItem] = note;
    else delete savedItemNotes[currentNoteItem];
    localStorage.setItem('itemNotes', JSON.stringify(savedItemNotes));
    document.getElementById('itemNoteModal').style.display = 'none';
    renderSalesItems();
  };
  document.getElementById('cancelItemNoteBtn').onclick = () => {
    document.getElementById('itemNoteModal').style.display = 'none';
  };
});

function renderSalesItems() {
  const container = document.getElementById('salesItems');
  container.innerHTML = '';
  const groups = {};

  itemsData.forEach(item => {
    const group = item.group || "Ø£Ø®Ø±Ù‰";
    if (!groups[group]) groups[group] = [];
    groups[group].push(item);
  });

  Object.keys(groups).sort().forEach(group => {
    const section = document.createElement('div');
    section.classList.add('group-section', 'group-collapsed');

    const header = document.createElement('div');
    header.classList.add('group-header');
    header.innerHTML = `<span>${group}</span><span class="group-arrow">â–¶ï¸</span>`;
    header.onclick = () => section.classList.toggle('group-collapsed');

    const groupItems = document.createElement('div');
    groupItems.classList.add('group-items');

    groups[group].forEach(item => {
      const name = item.name;
      const unit = item.unit || 'Ø¯Ø±Ø²Ù†';
      const image = item.image || '';
      const imgUrl = `https://raw.githubusercontent.com/T772299420/Aden_plaste/main/${image}`;
      const qty = savedQuantities[name] || '';
      const note = savedItemNotes[name] || '';
      const highlighted = qty ? 'highlighted' : '';

      const card = document.createElement('div');
      card.className = `item ${highlighted}`;
      card.innerHTML = `
        <div class="image-box"><img src="${imgUrl}" alt="${name}" /></div>
        <div class="item-details">
          <p>${highlightKeyword(name, currentKeyword)} (${unit})</p>
          <div class="item-controls">
            <label>Ø§Ù„ÙƒÙ…ÙŠØ©:
              <input type="number" dir="ltr" min="0" value="${qty}" data-name="${name}" oninput="onQuantityChange(this)" />
            </label>
            <button class="notes-btn" onclick="openItemNoteModal('${name}')">Ù…Ù„Ø§Ø­Ø¸Ø§Øª${note ? ' âœ“' : ''}</button>
          </div>
        </div>`;
      groupItems.appendChild(card);
    });

    section.appendChild(header);
    section.appendChild(groupItems);

    if (groups[group].some(i => i.name.toLowerCase().includes(currentKeyword))) {
      section.classList.remove('group-collapsed');
    }

    container.appendChild(section);
  });
}

function highlightKeyword(text, keyword) {
  if (!keyword) return text;
  const regex = new RegExp(`(${keyword})`, 'gi');
  return text.replace(regex, '<mark>$1</mark>');
}

function filterItems(keyword) {
  renderSalesItems(); // Ø³ÙŠØ£Ø®Ø° Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ© Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±
}

function openItemNoteModal(name) {
  currentNoteItem = name;
  document.getElementById('itemNoteTextarea').value = savedItemNotes[name] || '';
  document.getElementById('itemNoteModal').style.display = 'flex';
}

function onQuantityChange(input) {
  const qty = parseInt(input.value) || 0;
  const name = input.dataset.name;
  const itemCard = input.closest('.item');

  if (qty > 0) {
    savedQuantities[name] = qty;
    itemCard.classList.add('highlighted');
  } else {
    delete savedQuantities[name];
    delete savedItemNotes[name];
    itemCard.classList.remove('highlighted');
    localStorage.setItem('itemNotes', JSON.stringify(savedItemNotes));
  }

  localStorage.setItem('selectedQuantities', JSON.stringify(savedQuantities));
  updateButtonsVisibility();
}

function updateButtonsVisibility() {
  const visible = Object.keys(savedQuantities).length > 0;
  document.getElementById('showOrderBtn').style.display = visible ? 'inline-block' : 'none';
  document.getElementById('whatsappBtn').style.display = visible ? 'inline-block' : 'none';
}

function fillClientInputs() {
  document.getElementById('clientFullName').value = clientInfo.fullName || '';
  document.getElementById('clientTradeName').value = clientInfo.tradeName || '';
  document.getElementById('clientAddress').value = clientInfo.address || '';
  document.getElementById('clientPhone').value = clientInfo.phone || '';
}

function clearOrder() {
  savedQuantities = {};
  savedItemNotes = {};
  localStorage.removeItem('selectedQuantities');
  localStorage.removeItem('itemNotes');
  updateButtonsVisibility();
}

function sendOrderWhatsApp(note) {
  if (!clientInfo.phone) {
    alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„");
    return;
  }

  const today = new Date();
  const formattedDate = today.toISOString().split('T')[0];

  let message = `Ø£Ù†Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ / ${clientInfo.fullName || ''} - ${clientInfo.tradeName || ''}%0A`;
  message += `Ø¹Ù†ÙˆØ§Ù†ÙŠ / ${clientInfo.address || ''}%0A`;
  message += `Ø±Ù‚Ù… Ù‡Ø§ØªÙÙŠ / ${clientInfo.phone || ''}%0A`;
  message += `ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨ / ${formattedDate}%0A`;
  message += `__________________________%0A`;
  message += `Ø§Ù„Ø§ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:%0A`;

  Object.keys(savedQuantities).forEach(name => {
    const item = itemsData.find(i => i.name === name);
    const unit = item?.unit || 'ÙˆØ­Ø¯Ø©';
    const qty = savedQuantities[name];
    const noteItem = savedItemNotes[name] ? ` - Ù…Ù„Ø§Ø­Ø¸Ø©: ${savedItemNotes[name]}` : '';
    message += `- ${name} - ${unit} - ${qty}${noteItem}%0A`;
  });

  if (note) {
    message += `%0AÙ…Ù„Ø§Ø­Ø¸Ø§Øª Ø¹Ø§Ù…Ø©:%0A${encodeURIComponent(note)}`;
  }

  const url = `https://wa.me/967772299420?text=${message}`;
  window.open(url, '_blank');
}
</script>
</body>
  </html>
