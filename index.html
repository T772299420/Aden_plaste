<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ø´Ø±ÙƒØ© Ø¹Ø¯Ù† Ø§Ù„ÙˆØ·Ù†ÙŠØ© Ù„Ù„ØµÙ†Ø§Ø¹Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f9f9f9; margin: 0; padding: 0; color: #333; }
    h2 { color: #8B0000; margin-bottom: 20px; font-weight: 700; text-align: center; }
    #tabBar {
      background: #8B0000; display: flex; align-items: center;
      padding: 10px 15px; gap: 15px; flex-wrap: wrap; position: sticky; top: 0; z-index: 1000;
    }
    #tabBar button.tabBtn {
      background: transparent; border: none; color: #fff;
      font-size: 18px; cursor: pointer; padding: 10px 18px; border-radius: 8px;
    }
    #tabBar button.tabBtn.active, #tabBar button.tabBtn:hover {
      background: #f44336;
    }
    .search-container {
      margin-left: auto; display: flex; align-items: center; gap: 10px;
    }
    #searchInput {
      padding: 7px 12px; font-size: 16px; border-radius: 8px; border: none; width: 200px;
    }
    #searchBtn, #btnClientInfo {
      padding: 9px 14px; border-radius: 8px; cursor: pointer;
      font-size: 16px; border: none; color: #fff;
    }
    #searchBtn { background: #f44336; }
    #btnClientInfo { background: #004d40; margin-left: 10px; }
    .tabContent {
      display: none; padding: 20px; max-width: 1100px; margin: auto; background: white;
    }
    .tabContent.active { display: block; }
    .group-section { margin-bottom: 20px; }
    .group-header {
      background: #8B0000; color: #fff; padding: 12px 18px; font-size: 1.2rem; font-weight: bold;
      cursor: pointer; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
    }
    .group-items {
      display: grid; grid-template-columns: repeat(auto-fill,minmax(230px,1fr));
      gap: 20px; padding: 15px 10px;
    }
    .group-collapsed .group-items { display: none; }
    .group-arrow { font-size: 1.4rem; transition: transform 0.3s ease; }
    .group-collapsed .group-arrow { transform: rotate(90deg); }
    .item {
      border: 1px solid #ccc; padding: 10px; border-radius: 8px; background: #fefefe;
    }
    .item.highlighted { border-color: #f44336; background: #fff0f0; }
    .image-box img {
      width: 100%; height: 200px; object-fit: contain;
    }
    .item-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .item-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .notes-btn {
      background-color: #2196f3;
      border: none;
      color: white;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }
    mark {
      background: yellow; color: black; padding: 0 4px;
    }
    #bottomBar {
      position: fixed;
      bottom: 0;
      width: 100%;
      background: #fff;
      border-top: 1px solid #ccc;
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 10px;
      z-index: 1000;
    }
    #bottomBar button {
      padding: 10px 16px;
      font-size: 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: white;
    }
    #btnNewOrder { background-color: #FF9800; }
    #showOrderBtn { background-color: #2196F3; }
    #whatsappBtn { background-color: #25d366; }
  </style>
</head>
<body>
  <div id="tabBar">
    <button class="tabBtn active" data-tab="sales">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</button>
    <button class="tabBtn" data-tab="client">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</button>
    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† ØµÙ†Ù..." />
      <button id="searchBtn">ğŸ”</button>
    </div>
  </div>

  <div id="sales" class="tabContent active">
    <h2>Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
    <div id="salesItems"></div>
  </div>

  <div id="client" class="tabContent">
    <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
    <div>
      <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ:</label><input type="text" id="clientFullName" /><br><br>
      <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ:</label><input type="text" id="clientTradeName" /><br><br>
      <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø­Ù„:</label><input type="text" id="clientAddress" /><br><br>
      <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label><input type="text" id="clientPhone" dir="ltr" /><br><br>
      <button id="saveClientInfoBtn" class="btn-yes">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>
  </div>

  <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ Ø§Ù„Ø«Ø§Ø¨Øª -->
  <div id="bottomBar">
    <button id="btnNewOrder">ğŸ—‘ï¸ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</button>
    <button id="showOrderBtn" style="display:none;">ğŸ“„ Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø¨</button>
    <button id="whatsappBtn" style="display:none;">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
  </div>
  <script>
let itemsData = [];
let savedQuantities = JSON.parse(localStorage.getItem('selectedQuantities') || '{}');
let savedItemNotes = JSON.parse(localStorage.getItem('itemNotes') || '{}');
let clientInfo = JSON.parse(localStorage.getItem('clientInfo') || '{}');
let groupStates = {};
let lastOpenedGroup = '';

document.addEventListener('DOMContentLoaded', () => {
  fetch('https://raw.githubusercontent.com/T772299420/Aden_plaste/main/data%20(7).csv')
    .then(res => res.text())
    .then(text => {
      const rows = text.trim().split('\n').map(row => row.split(','));
      const headers = rows.shift();
      itemsData = rows.map(row => {
        const obj = {};
        headers.forEach((h, i) => obj[h.trim().toLowerCase()] = row[i]?.trim() || '');
        return obj;
      });

      if (Object.keys(savedQuantities).length > 0) {
        if (confirm("ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù…Ø­ÙÙˆØ¸ Ù…Ø³Ø¨Ù‚Ù‹Ø§ØŒ Ù‡Ù„ ØªØ±ØºØ¨ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ØŸ")) {
          clearOrder();
        }
      }

      renderSalesItems();
      fillClientInputs();
      updateButtonsVisibility();
    });

  document.getElementById('searchInput').addEventListener('input', (e) => {
    const keyword = e.target.value.trim().toLowerCase();
    renderSalesItems(keyword);
  });

  document.getElementById('saveClientInfoBtn').onclick = () => {
    clientInfo = {
      fullName: document.getElementById('clientFullName').value.trim(),
      tradeName: document.getElementById('clientTradeName').value.trim(),
      address: document.getElementById('clientAddress').value.trim(),
      phone: document.getElementById('clientPhone').value.trim(),
    };
    localStorage.setItem('clientInfo', JSON.stringify(clientInfo));
    alert("ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„");
  };

  document.querySelectorAll('.tabBtn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.tabBtn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tabContent').forEach(tab => tab.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(btn.dataset.tab).classList.add('active');
    });
  });

  document.getElementById('btnNewOrder').onclick = () => {
    if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¨Ø¯Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ØŸ")) {
      clearOrder();
      renderSalesItems();
      updateButtonsVisibility();
    }
  };

  document.getElementById('showOrderBtn').onclick = () => {
    const items = Object.keys(savedQuantities);
    if (!items.length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù Ù…Ø®ØªØ§Ø±Ø©.");
    let msg = "Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ:\n\n";
    items.forEach(name => {
      msg += `- ${name}: ${savedQuantities[name]}`;
      if (savedItemNotes[name]) msg += ` (Ù…Ù„Ø§Ø­Ø¸Ø©: ${savedItemNotes[name]})`;
      msg += '\n';
    });
    alert(msg);
  };

  document.getElementById('whatsappBtn').onclick = () => {
    if (!Object.keys(savedQuantities).length) return alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ØµÙ†Ø§Ù.");
    if (!clientInfo.phone) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£ÙˆÙ„Ù‹Ø§.");
    const date = new Date().toISOString().split('T')[0];
    let msg = `Ø£Ù†Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ / ${clientInfo.fullName || ''} - ${clientInfo.tradeName || ''}%0A`;
    msg += `Ø¹Ù†ÙˆØ§Ù†ÙŠ / ${clientInfo.address || ''}%0AØ±Ù‚Ù… Ù‡Ø§ØªÙÙŠ / ${clientInfo.phone || ''}%0AØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ù„Ø¨ / ${date}%0A`;
    msg += `__________________________%0AØ§Ù„Ø§ØµÙ†Ø§Ù Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:%0A`;
    Object.keys(savedQuantities).forEach(name => {
      const item = itemsData.find(i => i.name === name);
      const unit = item?.unit || 'ÙˆØ­Ø¯Ø©';
      const qty = savedQuantities[name];
      const note = savedItemNotes[name] ? ` - Ù…Ù„Ø§Ø­Ø¸Ø©: ${savedItemNotes[name]}` : '';
      msg += `- ${name} - ${unit} - ${qty}${note}%0A`;
    });
    const url = `https://wa.me/967772299420?text=${msg}`;
    window.open(url, '_blank');
  };
});

function renderSalesItems(keyword = '') {
  const container = document.getElementById('salesItems');
  container.innerHTML = '';
  const groups = {};

  itemsData.forEach(item => {
    const group = item.group || 'Ø£Ø®Ø±Ù‰';
    if (!groups[group]) groups[group] = [];
    groups[group].push(item);
  });

  Object.entries(groups).forEach(([group, items]) => {
    const matchedItems = keyword
      ? items.filter(i => i.name.toLowerCase().includes(keyword))
      : items;

    if (keyword && matchedItems.length === 0) return; // Ù„Ø§ ØªØ¹Ø±Ø¶ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©

    const section = document.createElement('div');
    section.className = 'group-section';

    const selectedCount = items.filter(i => savedQuantities[i.name]).length;
    const header = document.createElement('div');
    header.className = 'group-header';
    header.innerHTML = `<span>${group} - ${items.length} ØµÙ†Ù - ${selectedCount} Ù…Ø®ØªØ§Ø±</span><span class="group-arrow">â–¶ï¸</span>`;

    header.onclick = () => {
      const collapsed = section.classList.toggle('group-collapsed');
      groupStates[group] = !collapsed;
      if (!collapsed) lastOpenedGroup = group;
    };

    const itemsContainer = document.createElement('div');
    itemsContainer.className = 'group-items';

    matchedItems.forEach(item => {
      const name = item.name;
      const unit = item.unit || 'ÙˆØ­Ø¯Ø©';
      const image = item.image || '';
      const imgUrl = `https://raw.githubusercontent.com/T772299420/Aden_plaste/main/${image}`;
      const qty = savedQuantities[name] || '';
      const note = savedItemNotes[name] || '';

      const card = document.createElement('div');
      card.className = `item ${qty ? 'highlighted' : ''}`;
      card.innerHTML = `
        <div class="image-box"><img src="${imgUrl}" alt="${name}" /></div>
        <div class="item-details">
        <p>${highlightKeyword(name, keyword)} (${unit}) ${qty ? 'ğŸ‘' : ''}</p>
          <div class="item-controls">
            <label>Ø§Ù„ÙƒÙ…ÙŠØ©:
              <input type="number" dir="ltr" min="0" value="${qty}" data-name="${name}" oninput="onQuantityChange(this)" />
            </label>
            <button class="notes-btn" onclick="addNote('${name}')">Ù…Ù„Ø§Ø­Ø¸Ø§Øª${note ? ' âœ“' : ''}</button>
          </div>
        </div>`;
      itemsContainer.appendChild(card);
    });

    section.appendChild(header);
    section.appendChild(itemsContainer);

    // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©
    const shouldOpen = keyword
      ? true
      : (group === lastOpenedGroup || groupStates[group]);

    if (!shouldOpen) section.classList.add('group-collapsed');
    container.appendChild(section);
  });
}

function onQuantityChange(input) {
  const qty = parseInt(input.value) || 0;
  const name = input.dataset.name;
  const card = input.closest('.item');
  
  if (qty > 0) {
    savedQuantities[name] = qty;
    card.classList.add('highlighted');
  } else {
    delete savedQuantities[name];
    delete savedItemNotes[name];
    card.classList.remove('highlighted');
  }
  
  // âœ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ÙˆØ¥Ø¶Ø§ÙØ© Ø±Ù…Ø² ğŸ‘ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙ…ÙŠØ©
  const titleElement = input.closest('.item-details').querySelector('p');
  if (titleElement) {
    const unit = itemsData.find(i => i.name === name)?.unit || 'ÙˆØ­Ø¯Ø©';
    const keyword = document.getElementById('searchInput').value.trim().toLowerCase();
    titleElement.innerHTML = `${highlightKeyword(name, keyword)} (${unit}) ${qty ? 'ğŸ‘' : ''}`;
  }
  
  localStorage.setItem('selectedQuantities', JSON.stringify(savedQuantities));
  localStorage.setItem('itemNotes', JSON.stringify(savedItemNotes));
  updateButtonsVisibility();
}

function addNote(name) {
  const note = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø©:", savedItemNotes[name] || '');
  if (note !== null) {
    if (note.trim()) savedItemNotes[name] = note.trim();
    else delete savedItemNotes[name];
    localStorage.setItem('itemNotes', JSON.stringify(savedItemNotes));
    renderSalesItems(document.getElementById('searchInput').value.trim().toLowerCase());
    
    
  }
  
}

function highlightKeyword(text, keyword) {
  if (!keyword) return text;
  return text.replace(new RegExp(`(${keyword})`, 'gi'), `<mark>$1</mark>`);
}

function fillClientInputs() {
  document.getElementById('clientFullName').value = clientInfo.fullName || '';
  document.getElementById('clientTradeName').value = clientInfo.tradeName || '';
  document.getElementById('clientAddress').value = clientInfo.address || '';
  document.getElementById('clientPhone').value = clientInfo.phone || '';
}

function clearOrder() {
  savedQuantities = {};
  savedItemNotes = {};
  localStorage.removeItem('selectedQuantities');
  localStorage.removeItem('itemNotes');
  updateButtonsVisibility();
}

function updateButtonsVisibility() {
  const visible = Object.keys(savedQuantities).length > 0;
  document.getElementById('showOrderBtn').style.display = visible ? 'inline-block' : 'none';
  document.getElementById('whatsappBtn').style.display = visible ? 'inline-block' : 'none';
}
</script>
</body>
  </html>
